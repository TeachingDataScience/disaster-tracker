/* relief-web-disaster-tracker */
var app=app||{};!function(){app.events=_.extend({},Backbone.Events)}(jQuery),function(){"use strict";app.story=Backbone.Model.extend({defaults:{body:"",country:[],date:{},disaster:[],origin:"",source:[],title:"",url:"",vulnerable_groups:[],headline:[],language:[]}}),app.tweet=Backbone.Model.extend({}),app.marker=Backbone.Model.extend({})}(),String.prototype.trunc=String.prototype.trunc||function(n){return this.length>n?this.substr(0,this.substr(0,n-1).lastIndexOf(" "))+"...":this},function(){"use strict";var months=["January","February","March","April","May","June","July","August","September","October","November","December"],Stories=Backbone.Collection.extend({model:app.story,url:"http://api.rwlabs.org/v0/report/list",initialize:function(){this.page=0,"undefined"!=typeof this.perPage||(this.perPage=4)},parse:function(resp){var models=resp.data?resp.data.list||resp.data.info||{}:{};return this.total=models.length,this.page=0,_.map(models,function(model){var fields=model.fields,html=fields["body-html"],lead=html?html.trunc(105):"No description available",date=fields.date,dateline=date&&date.created?this.getDate(date.created):"";return _.extend({},fields,{lead:lead,dateline:dateline})},this)},getPage:function(){var start=this.page*this.perPage,end=start+this.perPage;return end=end<this.total?end:this.total,this.models.slice(start,end)},getDate:function(date){var dateObj;try{dateObj=new Date(date)}catch(e){return""}return[dateObj.getDate(),months[dateObj.getMonth()]+",",dateObj.getFullYear()].join(" ")},pageInfo:function(){return{page:this.page,pages:Math.ceil(this.total/this.perPage),perPage:this.perPage}},nextPage:function(){return this.page<this.pageInfo().pages-1&&(this.page=this.page+1,this.trigger("reflow")),!1},previousPage:function(){return this.page>=1&&(this.page=this.page-1,this.trigger("reflow")),!1},jump:function(toPage){return this.page=toPage,this.trigger("reflow"),!1}}),Tweets=Backbone.Collection.extend({model:app.tweet,url:"https://s3-us-west-2.amazonaws.com/reliefweb/tweets.json"}),Markers=Backbone.Collection.extend({url:"data/current.geojson"}),Historical=Backbone.Collection.extend({url:"data/ph-disasters-all.json",entitles:[],parse:function(resp){return this.entities=_.chain(resp).groupBy(function(obj){return obj.dis_type}).keys().value(),resp},yearsFrom:function(start){var years=_.chain(this.models).groupBy(function(model){return model.attributes.year}).toArray().filter(function(year){return parseInt(year[0].attributes.year,10)>=start}).value();return years}}),Demographic=Backbone.Collection.extend({url:"http://data.undp.org/resource/e6xu-b22v.json"}),Demographic0=Backbone.Collection.extend({url:"http://data.undp.org/resource/wxub-qc5k.json"});app.stories=new Stories,app.tweets=new Tweets,app.markers=new Markers,app.historical=new Historical,app.demographics=new Demographic,app.demographics0=new Demographic0}(),function($){"use strict";function getToday(){var date=new Date,parsed=[date.getMonth()+1,date.getDate(),date.getFullYear()];return parsed[0]=parsed[0]<10?"0".concat(parsed[0]):parsed[0],parsed.join("-")}app.MainStoryView=Backbone.View.extend({el:"#main-story",initialize:function(){app.events.on("map:loaded",this.show,this)},show:function(){this.$el.addClass("slide-in")}}),app.MapView=Backbone.View.extend({el:"#app-map",template:_.template($("#marker-template").html()),events:{},initialize:function(){this.listenTo(app.markers,"reset",this.addMarker),app.markers.fetch({reset:!0}),this.map=L.mapbox.map("app-map","jue.hb9ikea3",{minZoom:3,maxZoom:8,scrollWheelZoom:!1});var onload=$.proxy(this.onload,this);window.setTimeout(onload,800)},onload:function(){app.events.trigger("map:loaded")},show:function(){this.$el.addClass("show")},fade:function(){this.$el.removeClass("show")},addMarker:function(){var view=this,featureCollection=app.markers.toJSON();_.each(featureCollection,function(f){f.properties["marker-size"]="small",f.properties["marker-color"]="#E68080",f.properties.popup=view.template(f)}),L.geoJson(featureCollection,{pointToLayer:L.mapbox.marker.style,onEachFeature:function(feature,layer){var brief=L.popup({closeButton:!1,minWidth:320,offset:new L.Point(0,-20)}).setContent(feature.properties.popup).setLatLng(layer.getLatLng());view.map.openPopup(brief),layer.bindPopup(brief)}}).addTo(this.map)}}),app.AppView=Backbone.View.extend({el:"#disaster-app",initialize:function(){this.$reports=this.$("#report-list"),this.$tweets=this.$("#tweet-list"),this.$demo=this.$("#demographic-chart"),this.listenTo(app.stories,"reset",this.addReports),this.listenTo(app.stories,"reflow",this.addReports),this.listenTo(app.tweets,"reset",this.addTweets),this.listenTo(app.demographics,"reset",this.addAllDemo),this.listenTo(app.demographics0,"reset",this.addAllDemo),app.events.trigger("app:start"),app.tweets.fetch({reset:!0});this.country="PHL",app.demographics.fetch({reset:!0}),app.demographics0.fetch({reset:!0})},addReports:function(){this.$reports.empty(),_.each(app.stories.getPage(),this.addStory,this)},addStory:function(story){var reportView=(story.attributes.disaster,new app.ReportView({model:story}));this.$reports.append(reportView.render().el).fadeIn(200)},addTweets:function(){_.each(app.tweets.models,this.addTweet,this)},addTweet:function(tweet){var tweetView=new app.TweetView({model:tweet});this.$tweets.append(tweetView.render().el)},addAllDemo:function(){this.$demo.empty();var demoView,demoView0;app.demographics.each(this.addDemo,this),app.demographics0.each(this.addDemo0,this),app.demographics.length>0&&(demoView=new app.DemoView({model:this.demo}),this.$demo.append(demoView.render().el)),app.demographics0.length>0&&(demoView0=new app.DemoView0({model:this.demo0}),this.$demo.find("table").append(demoView0.render().el))},addDemo:function(){this.demo=app.demographics.findWhere({country_code:this.country})},addDemo0:function(){this.demo0=app.demographics0.findWhere({abbreviation:this.country})}}),app.ReportSearch=Backbone.View.extend({el:"#report-search",text:{hide:"Hide",show:"More Options"},events:{"click #expand-search":"toggleSearch",submit:"updateQuery"},initialize:function(){app.events.once("app:start",this.updateQuery,this),this.$below=this.$("#search-options"),this.$toggle=this.$("#expand-search"),this.toggled=!1,this.$forms={query:this.$("#report-query-value"),dateStart:this.$("#datepicker-start"),dateEnd:this.$("#datepicker-end"),limit:this.$("#report-number"),exclude:this.$("#report-exclude")};var opts={format:"mm-dd-yyyy"};this.$forms.dateStart.val("01-01-2013").fdatepicker(opts),this.$forms.dateEnd.val(getToday()).fdatepicker(opts)},limit:20,params:{limit:0,fields:{include:{0:"body-html",1:"country",2:"date",3:"disaster",4:"file",5:"headline",6:"ocha_product",7:"origin",8:"source",9:"title",10:"url",11:"vulnerable_groups",12:"headline",13:"language",14:"format"}}},query:{value:"",fields:{0:"title"},operator:"OR"},filter:{operator:"AND",conditions:{0:{field:"title",value:"",negate:!0},1:{field:"date.created",value:{from:"",to:""}},2:{field:"format.name",value:{0:"News and Press",1:"Infographic",2:"Map"},operator:"OR",negate:!0}}},sort:{0:"date:desc"},updateQuery:function(){var dateStart,dateEnd,target="";return target=this.$forms.query.val(),target&&target!==this.query.value?this.query.value=target:(app.events.trigger("reports-search:error",this.$forms.query),this.query.value="Haiyan"),target=parseInt(this.$forms.limit.val(),10),target&&0/0!==target?0>=target||target>1e3?app.events.trigger("reports-search:error",this.$forms.limit):this.params.limit=target:(this.params.limit=this.limit,this.$forms.limit.val("")),target=this.$forms.dateStart.val().split("-"),dateStart=new Date(target[2],target[1],target[1]).getTime(),target=this.$forms.dateEnd.val().split("-"),dateEnd=new Date(target[2],target[1],target[1]).getTime(),dateStart>dateEnd?app.events.trigger("reports-search:error",this.$forms.dateEnd):(this.filter.conditions[1].value.from=dateStart,this.filter.conditions[1].value.to=dateEnd),target=this.$forms.exclude.val(),target?(target=target.replace(/,/g,""),this.filter.conditions[0].value=target):this.filter.conditions[0].value="zzzxxxxzzz",this.newApiSearch(),!1},newApiSearch:function(){app.stories.fetch({reset:!0,data:_.extend({},this.params,{query:this.query,filter:this.filter,sort:this.sort})})},toggleSearch:function(){this.toggled=!this.toggled,this.$below.toggleClass("hidden");var toggleText=this.toggled?this.text.hide:this.text.show;return this.$toggle.html(toggleText),!1}}),app.PaginatedView=Backbone.View.extend({el:"#report-pagination",template:_.template($("#pagination-template").html()),name:"pager",events:{"click .prev":"previous","click .next":"next","click .pagination-item":"jump"},initialize:function(){this.$after=this.$(".prev"),this.listenTo(app.stories,"reset",this.render),this.listenTo(app.stories,"reflow",this.reflow)},render:function(){this.$(".pagination-item").remove(),this.pageInfo=app.stories.pageInfo();for(var fragment=new Array(this.pageInfo.pages),i=0,ii=fragment.length;ii>i;++i)fragment[i]=this.renderOne(i);this.$after.after($(fragment.join(""))),this.refresh()},renderOne:function(index){return this.template({num:index,id:this.name.concat(index)})},previous:function(){return app.stories.previousPage(),!1},next:function(){return app.stories.nextPage(),!1},jump:function(event){var target=event.currentTarget.id.slice(this.name.length);return this.pageInfo.page!==target&&app.stories.jump(event.currentTarget.id.slice(this.name.length)),!1},reflow:function(){this.pageInfo=app.stories.pageInfo(),this.refresh()},refresh:function(){this.$(".current").removeClass("current"),this.$(".pagination-item").eq(this.pageInfo.page).addClass("current")}}),app.TweetView=Backbone.View.extend({tagName:"div",template:_.template($("#tweet-template").html()),render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el.addClass("report medium-4 column"),this}}),app.ReportView=Backbone.View.extend({tagName:"div",template:_.template($("#report-template").html()),render:function(){return this.$el.html(this.template(this.model.toJSON())),this.$el.addClass("report medium-6 column"),this}}),app.DemoView=Backbone.View.extend({tagName:"div",template:_.template($("#demo-template").html()),render:function(){return this.$el.html(this.template(this.model.toJSON())),this}}),app.DemoView0=Backbone.View.extend({tagName:"tr",template:_.template($("#demo0-template").html()),render:function(){return this.$el.html(this.template(this.model.toJSON())),this}})}(jQuery),function(){"use strict";var GraphView=Backbone.View.extend({el:"#historical-chart",margin:{top:20,right:40,bottom:20,left:10},width:800,height:300,x:d3.scale.ordinal(),y:d3.scale.linear(),set:[],start:1940,end:2014,max:0,min:0,stack:d3.layout.stack(),entities:[],initialize:function(){this.listenTo(app.historical,"reset",this.render),app.historical.fetch({reset:!0}),this.svg=d3.select("#historical-chart").append("svg:svg").attr("width",this.width).attr("height",this.height).append("g").attr("transform","translate("+this.margin.left+","+this.margin.top+")"),this.height-=this.margin.top+this.margin.bottom,this.width-=this.margin.right+this.margin.left,this.x.domain(d3.range(this.start,this.end)).rangeRoundBands([0,this.width],.08),this.y.range([this.height,0])},render:function(){this.set=app.historical.yearsFrom(this.start);var max=d3.max(_.map(this.set,function(year){return _.reduce(year,function(memo,model){return model.attributes.y0=parseInt(memo,10),memo+model.attributes.no_killed},0)}));this.y.domain([0,max]);{var y=this.y,x=this.x,xAx=d3.svg.axis().scale(x).tickSize(0).tickPadding(6).orient("bottom").tickFormat(function(d){return d%10===0?d:""}),yAx=d3.svg.axis().scale(y).tickSize(0).tickPadding(6).ticks(4).orient("right"),layer=this.svg.selectAll("layer").data(this.set).enter().append("g").attr("class","layer");layer.selectAll("rect").data(function(d){return d}).enter().append("rect").attr("x",function(d){return x(parseInt(d.attributes.year,10))}).attr("y",function(d){return y(d.attributes.y0+d.attributes.no_killed)}).attr("width",x.rangeBand()).attr("height",function(d){return y(d.attributes.y0)-y(d.attributes.y0+d.attributes.no_killed)}).attr("class",function(d){var cls=d.attributes.dis_type.split(" ");return cls[0].toLowerCase()})}this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(xAx),this.svg.append("g").attr("class","y axis").attr("transform","translate("+this.width+",0)").call(yAx)}});app.historicalGraph=new GraphView}(jQuery),$(function(){"use strict";var views=["MainStoryView","MapView","PaginatedView","ReportSearch","AppView"];_.each(views,function(view){new app[view]})});